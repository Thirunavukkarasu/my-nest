name: Build Android APK

on:
  push:
    tags:
      - "v*"
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      build_profile:
        description: "Build profile (preview or production)"
        required: true
        default: "preview"
        type: choice
        options:
          - preview
          - production

jobs:
  build:
    name: Build APK with EAS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.11.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.18.0"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Determine build profile
        id: build_profile
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "profile=${{ github.event.inputs.build_profile }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]] || [ "${{ github.event_name }}" == "release" ]; then
            echo "profile=production" >> $GITHUB_OUTPUT
          else
            echo "profile=preview" >> $GITHUB_OUTPUT
          fi

      - name: Build APK with EAS
        id: build
        run: |
          cd apps/mobile
          # Build and wait for completion (max 30 minutes)
          BUILD_OUTPUT=$(eas build --platform android --profile ${{ steps.build_profile.outputs.profile }} --non-interactive --wait --json)
          echo "build_output<<EOF" >> $GITHUB_OUTPUT
          echo "$BUILD_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Extract build ID and status
          BUILD_ID=$(echo "$BUILD_OUTPUT" | jq -r '.id // empty')
          BUILD_STATUS=$(echo "$BUILD_OUTPUT" | jq -r '.status // empty')

          if [ -n "$BUILD_ID" ]; then
            echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          fi
          if [ -n "$BUILD_STATUS" ]; then
            echo "build_status=$BUILD_STATUS" >> $GITHUB_OUTPUT
          fi

          # Fail if build status is not finished
          if [ "$BUILD_STATUS" != "finished" ]; then
            echo "Build failed with status: $BUILD_STATUS"
            exit 1
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Download APK
        if: steps.build.outputs.build_status == 'finished'
        run: |
          cd apps/mobile
          mkdir -p ./build
          eas build:download --id ${{ steps.build.outputs.build_id }} --output-dir ./build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Upload APK artifact
        if: steps.build.outputs.build_status == 'finished'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ steps.build_profile.outputs.profile }}
          path: apps/mobile/build/*.apk
          retention-days: 90
          if-no-files-found: error

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/') && steps.build.outputs.build_status == 'finished'
        uses: softprops/action-gh-release@v1
        with:
          files: apps/mobile/build/*.apk
          draft: false
          prerelease: false
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
